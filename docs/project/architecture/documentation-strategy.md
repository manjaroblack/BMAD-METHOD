# Documentation Strategy (Architecture)

This document defines the docs-as-code strategy for the project. It centralizes how we write, test, version, build, and publish documentation for developers and users.

## Goals & Principles

- Single source of truth from TypeScript types and JSDoc/TSDoc.
- Executable examples (doctests) to prevent drift.
- Stable, versioned API docs hosted via JSR; narrative guides built with a Deno-native SSG.
- Fast, privacy-friendly static search using Pagefind.
- CI-enforced quality gates for docs correctness and completeness.

## Sources of Truth

- API Reference: generated by `deno doc` from `*.ts` with JSDoc.
- Narrative Guides & How-tos: authored in Markdown/MDX and built by Lume.
- Inline Examples: fenced `ts` code blocks that are executed by doctests.

## JSDoc/TSDoc Conventions

- Document every exported symbol with a one-line summary.
- Provide `@example` with fenced `ts` blocks. Keep examples copy-pasteable.
- Be explicit with `@throws` types and required permissions (e.g., `Requires --allow-read`).
- Use `@deprecated`, `@experimental`, and `@since` lifecycle tags where applicable.

Example:

```ts
/**
 * Parse a JSONC config file into a typed Config.
 *
 * @example
 * ```ts
 * import { parseConfig } from "jsr:@scope/pkg@1";
 * const cfg = await parseConfig("deno.jsonc");
 * ```
 * @throws {ConfigError} on invalid syntax
 * @permission --allow-read for the config file path
 */
export async function parseConfig(path: string): Promise<Config> {
  // ...
}
```

## Doctests (Executable Examples)

- Run doctests locally and in CI:

```bash
deno test --doc README.md docs/**/*.md
```

- Scope doctests to key docs (README, guides) and pin imports to major JSR versions (e.g., `jsr:@scope/pkg@1`).

## deno doc Tasks

- Lint API docs: `deno doc --lint mod.ts`
- Generate HTML: `deno doc --html --name="Project" --output=docs/api mod.ts`
- Emit JSON: `deno doc --json mod.ts > docs/api.json`

Recommended deno.jsonc tasks:

```jsonc
{
  "tasks": {
    "docs:test": "deno test --doc README.md docs/**/*.md",
    "api:lint": "deno doc --lint mod.ts",
    "api:html": "deno doc --html --name=\"Project\" --output=docs/api mod.ts",
    "api:json": "deno doc --json mod.ts > docs/api.json"
  }
}
```

## Versioning & Linking

- Link to canonical, versioned API docs on JSR.
- Examples should use major-pinned imports: `jsr:@scope/pkg@1`.
- Prefer guide links to API references rather than duplicating API details.

## Documentation Site (Lume)

- Static site generator for narrative docs; built with Deno.
- Plugins:
  - `pagefind`: static, fast, privacy-friendly search
  - `mdx`: author guides in MDX + TSX with typed UI components
  - `prism`: syntax highlighting
  - `multilanguage`: optional i18n and versioned subdirectories
  - `katex`: optional math rendering

Example `docs/_config.ts`:

```ts
import lume from "lume/mod.ts";
import mdx from "lume/plugins/mdx.ts";
import prism from "lume/plugins/prism.ts";
import pagefind from "lume/plugins/pagefind.ts";
import multilanguage from "lume/plugins/multilanguage.ts";
import katex from "lume/plugins/katex.ts";

export default lume()
  .use(mdx())
  .use(prism())
  .use(pagefind({
    ui: { containerId: "search", resetStyles: true },
    indexing: { rootSelector: "html", verbose: false },
  }))
  .use(multilanguage({ languages: ["en"] }))
  .use(katex());
```

Notes:

- For MDX + TSX, set in `deno.jsonc`:

```jsonc
{
  "compilerOptions": {
    "jsx": "react-jsx",
    "jsxImportSource": "lume"
  }
}
```

## Search (Pagefind)

- The Lume Pagefind plugin indexes the built HTML and exposes a lightweight UI.
- Alternatively, run the CLI directly after site build:

```bash
npx -y pagefind --site public --serve
```

- For multi-site or versioned indexes, use `mergeIndex` or publish per-version bundles.

## CI Integration

- Jobs:
  1. Lint & format: `deno fmt --check`, `deno lint`.
  2. Tests: `deno test` + `deno test --doc`.
  3. API Docs: `deno doc --lint`; optionally build HTML/JSON artifacts.
  4. Docs Site: build Lume, run Pagefind indexing, upload artifacts.
  5. Deploy: publish docs site (if enabled) and rely on JSR for API docs.

## Directory Structure

- `docs/` contains narrative docs and site config; API HTML artifacts (optional) at `docs/api/`.
- Keep build tasks decoupled from application builds.

## References (Latest)

- Lume plugins: MDX, Prism, Pagefind, Multilanguage, KaTeX — see official docs on lume.land.
- Pagefind: CLI and programmatic APIs; default UI usage — cloudcannon/pagefind.
- Deno: `deno doc`, doctests, testing — docs.deno.com.
- Keep build tasks decoupled from application builds.
