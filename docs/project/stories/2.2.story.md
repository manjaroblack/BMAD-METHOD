# Story 2.2: Toolkit Service, Toolkit View, and CLI Bypass

## Status

Draft

## Story

**As a** Developer, **I want** to run project Toolkit tasks from a TUI and directly via CLI, **so that** I can execute and automate workflows quickly without context switching.

### Dependencies

- Depends on completion of Story 2.1
- Parent Epic: [Epic 2 – TUI Core & Toolkit Implementation](../prd/epic-2-tui-core-toolkit-implementation.md)

## Acceptance Criteria

1. Toolkit Service provides task discovery and execution
   - Expose `listTasks(): Promise<Array<{ name: string; command: string }>>`
   - Expose `runTask(name: string, args?: string[]): Promise<{ code: number }>`
   - Reads `deno.json` or `deno.jsonc` tasks and executes the selected task as a subprocess
   - Implemented via dependency injection and consumed by views/CLI
   - [Source](../architecture/components.md#core-services)
   - [Source](../architecture/frontend-architecture-tui.md)
2. Toolkit Menu View lists tasks and runs selected task
   - Accessible from Main Menu; uses `currentView` routing
   - Renders available tasks from Toolkit Service; on selection, invokes `runTask`
   - Shows basic result (success/failure) and allows navigating back
   - [Source](../architecture/components.md#ui-components)
   - [Source](../architecture/frontend-architecture-tui.md)
3. CLI bypass to run toolkit tasks without launching the TUI
   - New CLI path accepts a task name (and optional args) and executes via Toolkit Service
   - Returns process exit code appropriately
   - [Source](../prd/epic-2-tui-core-toolkit-implementation.md)
4. Centralized dependencies
   - All external imports for view/service go through `deps.ts` (JSR-first; pinned URLs where needed)
   - [Source](../typescript-rules.md#dependency--import-strategy-jsr-first-depsts-pinning)
   - [Source](../architecture/tech-stack.md)
5. Tests
   - Service unit tests for task discovery (valid/invalid `deno.json`) and execution (happy/error paths)
   - View tests verifying list rendering and invocation via DI stub
   - CLI bypass test validating argument parsing and exit code propagation
   - Tests reside under top-level `tests/` mirroring `src/` structure
   - [Source](../architecture/testing-strategy.md)

## Tasks / Subtasks

- [ ] Toolkit Service (AC: 1,4)
  - [ ] Implement `listTasks()` and `runTask()` in `src/services/toolkit_service.ts` (file stub exists from 2.1)
  - [ ] Execute tasks as subprocesses; capture exit code
  - [ ] Add JSDoc (examples) for exported APIs
- [ ] Toolkit Menu View (AC: 2,4)
  - [ ] Create `src/tui/views/ToolkitMenuView.ts` to list available tasks and trigger execution
  - [ ] Integrate navigation from Main Menu using `currentView` (e.g., `ToolkitMenu`)
  - [ ] Display simple result status and back navigation
- [ ] DI & Wiring (AC: 1–3)
  - [ ] Ensure `src/core/di.ts` provides a concrete `ToolkitService` implementation
  - [ ] Wire Main Menu action to navigate to `ToolkitMenu`
- [ ] CLI Bypass (AC: 3,4)
  - [ ] Create or extend `src/tui/cli.ts` to support running toolkit task directly (e.g., `--toolkit <task> [-- args...]`)
  - [ ] Propagate exit code; avoid launching TUI on bypass
  - [ ] Usage text and minimal errors for unknown tasks
- [ ] Tests (AC: 5)
  - [ ] `tests/services/toolkit_service_test.ts`: discovery + execution (stub subprocess in unit; integration variant optional)
  - [ ] `tests/tui/toolkit_menu_view_test.ts`: lists tasks and invokes service via DI stub
  - [ ] `tests/cli_toolkit_bypass_test.ts`: runs bypass path and asserts exit code/behavior
- [ ] Documentation links (Epic alignment)
  - [ ] Cross-link Toolkit story/tasks with [Epic 2](../prd/epic-2-tui-core-toolkit-implementation.md)
  - [ ] Add CLI usage examples validated by doctests (see [architecture/documentation-strategy.md](../architecture/documentation-strategy.md))

## Dev Notes

### Previous Story Insights

- TUI shell, dynamic header, global keys, and signal-based routing are in place from Story 2.1; reuse the DI pattern and `currentView` routing established there.
  - [Source](../stories/2.1.story.md#dev-notes)

### Architecture & Routing

- Views are top-level components; routing via global `currentView` managed by `TuiApplication.ts`; views communicate with services via DI.
  - [Source](../architecture/frontend-architecture-tui.md)
- Toolkit Menu View is a UI component that lists and executes tasks.
  - [Source](../architecture/components.md#ui-components)

### Services

- Toolkit Service reads `deno.json` tasks and executes them as subprocesses; expose discovery and execution methods; integrate via DI.
  - [Source](../architecture/components.md#core-services)
- Services follow in-process modular system conventions.
  - [Source](../architecture/backend-architecture-core-services.md)

### File Locations

- Place Toolkit Menu under `src/tui/views/`; Toolkit Service under `src/services/`; DI in `src/core/di.ts`; tests under `tests/` mirroring `src/`.
  - [Source](../architecture/unified-project-structure.md#tui-application-structure)

### Testing Requirements

- Use Deno test runner; unit tests for service and view; CLI bypass tests; consider doctests for CLI examples.
  - [Source](../architecture/testing-strategy.md)
  - [Source](../architecture/documentation-strategy.md)

### Technical Constraints

- Runtime: Deno 2; Language: TypeScript; centralized deps via `deps.ts`.
  - [Source](../architecture/tech-stack.md)

### Assumptions

- `deno.json` or `deno.jsonc` exists at the repository root and defines tasks under the standard `tasks` map; Toolkit Service will read this file by default. No specific path guidance found in architecture docs.
  - [Source](../architecture/components.md#core-services)
- CLI bypass will use `Deno.Command` to execute tasks and propagate exit codes; requires appropriate permissions.
  - [Source](../architecture/tech-stack.md)

### Permissions

- CLI bypass will require appropriate permissions to run subprocesses and read `deno.json`/`deno.jsonc`.
  - [Source](../architecture/components.md#core-services)

### Project Structure Notes

- Keep new files aligned with the unified structure; ensure imports are centralized and version-pinned.
  - [Source](../architecture/unified-project-structure.md#tui-application-structure)

## Change Log

| Date       | Version | Description                                   | Author |
| ---------- | ------- | --------------------------------------------- | ------ |
| 2025-08-15 | v0      | Initial Draft created for Story 2.2           | SM     |

## Dev Agent Record

### Agent Model Used

- TBD

### Debug Log References

- TBD

### Completion Notes List

- TBD

### File List

- TBD

## QA Results

- TBD
