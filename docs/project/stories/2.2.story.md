# Story 2.2: Toolkit Service, Toolkit View, and CLI Bypass

## Status

Done

## Story

**As a** Developer, **I want** to run project Toolkit tasks from a TUI and directly via CLI, **so that** I can execute and automate workflows quickly without context switching.

### Dependencies

- Depends on completion of Story 2.1
- Parent Epic: [Epic 2 – TUI Core & Toolkit Implementation](../prd/epic-2-tui-core-toolkit-implementation.md)

## Acceptance Criteria

1. Toolkit Service provides task discovery and execution
   - Expose `listTasks(): Promise<Array<{ name: string; command: string }>>`
   - Expose `runTask(name: string, args?: string[]): Promise<{ code: number }>`
   - Reads root `deno.json` or `deno.jsonc` tasks and maps `{ [name: string]: string }` to `Array<{ name, command }>`
   - Implemented via dependency injection and consumed by views/CLI
   - Unknown task passed to `runTask` rejects with a clear error message
   - Public APIs documented with JSDoc including required permissions (`--allow-read`, `--allow-run`) and examples
   - [Source](../architecture/components.md#core-services)
   - [Source](../architecture/frontend-architecture-tui.md)
2. Toolkit Menu View lists tasks and runs selected task
   - Accessible from Main Menu; uses `currentView` routing
   - Renders available tasks from Toolkit Service; on selection, invokes `runTask`
   - Displays result message: `Task "<name>" exited with code <code>`
   - Includes "Back" action to return to Main Menu
   - Empty state: show "No tasks found" when no tasks are available
   - [Source](../architecture/components.md#ui-components)
   - [Source](../architecture/frontend-architecture-tui.md)
3. CLI bypass to run toolkit tasks without launching the TUI
   - Accepts `--toolkit <task> [-- args...]` (parsed via `parseFlags` from `deps.ts`)
   - Executes via `ToolkitService.runTask()` and prints result summary
   - Exits with the task's process exit code; on unknown task: print suggestions and exit with code `1`
   - Does not launch the TUI on bypass path; usage/help text updated accordingly
   - Required permissions on bypass path: `--allow-read`, `--allow-run`
   - [Source](../prd/epic-2-tui-core-toolkit-implementation.md)
4. Centralized dependencies
   - All external imports for view/service go through `deps.ts` (JSR-first; pinned URLs where needed)
   - [Source](../typescript-rules.md#dependency--import-strategy-jsr-first-depsts-pinning)
   - [Source](../architecture/tech-stack.md)
5. Tests
   - Service unit tests: discovery for valid/invalid `deno.json`/`deno.jsonc`, empty `tasks`, malformed files
   - Service execution tests: success and error paths; unknown task rejection; stub or wrap `Deno.Command`
   - View tests: list rendering, selection invokes service via DI stub; empty-state rendering; result message
   - CLI bypass tests: parse `--toolkit`, invoke service, propagate exit code; unknown task prints suggestions and exits `1`; usage/help output
   - Tests reside under top-level `tests/` mirroring `src/` structure
   - [Source](../architecture/testing-strategy.md)

## Tasks / Subtasks

- [x] Toolkit Service (AC: 1,4)
  - [x] Implement `listTasks()` and `runTask()` in `src/services/toolkit_service.ts` (file stub exists from 2.1)
  - [x] Execute tasks as subprocesses; capture exit code
  - [x] Add JSDoc (examples) for exported APIs
- [x] Toolkit Menu View (AC: 2,4)
  - [x] Create `src/tui/views/ToolkitMenuView.ts` to list available tasks and trigger execution
  - [x] Integrate navigation from Main Menu using `currentView` (e.g., `ToolkitMenu`)
  - [x] Display simple result status and back navigation
- [x] DI & Wiring (AC: 1–3)
  - [x] Ensure `src/core/di.ts` provides a concrete `ToolkitService` implementation
  - [x] Wire Main Menu action to navigate to `ToolkitMenu`
  - [x] Add `createServices()` for production and retain `createStubServices()` for tests in `src/core/di.ts`
  - [x] Mount `ToolkitMenuView` in `src/tui/TuiApplication.ts` when `currentView` is `Toolkit`
- [x] CLI Bypass (AC: 3,4)
  - [x] Extend main CLI entry `src/main.ts` to support `--toolkit <task> [-- args...]` (use `parseFlags` from `deps.ts`)
  - [x] Do not launch the TUI when `--toolkit` is provided
  - [x] Propagate exit code from `ToolkitService.runTask()`; on unknown task print suggestions and exit `1`
  - [x] Update usage/help text to document `--toolkit` and examples
- [x] Tests (AC: 5)
  - [x] `tests/services/toolkit_service_test.ts`: discovery + execution (stub subprocess in unit; integration variant optional)
  - [x] `tests/tui/toolkit_menu_view_test.ts`: lists tasks and invokes service via DI stub
  - [x] `tests/cli/toolkit_cli_test.ts`: runs bypass path and asserts exit code/behavior
- [x] Documentation links (Epic alignment)
  - [x] Cross-link Toolkit story/tasks with [Epic 2](../prd/epic-2-tui-core-toolkit-implementation.md)
  - [x] Add CLI usage examples validated by doctests (see [architecture/documentation-strategy.md](../architecture/documentation-strategy.md))

    Example (CLI bypass):

    ```sh
    deno run -A src/main.ts --toolkit lint -- --fix
    ```

    Doctest (ensures usage mentions toolkit):

    ```ts
    import { getUsage } from '../../../src/main.ts';
    if (!getUsage().includes('--toolkit')) {
      throw new Error('usage missing --toolkit option');
    }
    ```

## Dev Notes

### Implementation Readiness

- Not Ready for implementation: blocking items identified by PO validation.
- Gating items:
  - Implement `ToolkitService` (`listTasks`, `runTask`) with JSON/JSONC parsing and subprocess execution
  - Create `ToolkitMenuView` and mount it in `TuiApplication`
  - Implement CLI bypass (`--toolkit`) with exit code propagation and usage updates
  - Add required unit tests for service/view/CLI

### Previous Story Insights

- TUI shell, dynamic header, global keys, and signal-based routing are in place from Story 2.1; reuse the DI pattern and `currentView` routing established there.
  - [Source](../stories/2.1.story.md#dev-notes)

### Architecture & Routing

- Views are top-level components; routing via global `currentView` managed by `TuiApplication.ts`; views communicate with services via DI.
  - [Source](../architecture/frontend-architecture-tui.md)
- Toolkit Menu View is a UI component that lists and executes tasks.
  - [Source](../architecture/components.md#ui-components)

### Services

- Toolkit Service reads `deno.json` tasks and executes them as subprocesses; expose discovery and execution methods; integrate via DI.
  - [Source](../architecture/components.md#core-services)
- Services follow in-process modular system conventions.
  - [Source](../architecture/backend-architecture-core-services.md)

### File Locations

- Place Toolkit Menu under `src/tui/views/`; Toolkit Service under `src/services/`; DI in `src/core/di.ts`; tests under `tests/` mirroring `src/`.
  - [Source](../architecture/unified-project-structure.md#tui-application-structure)

### Testing Requirements

- Use Deno test runner; unit tests for service and view; CLI bypass tests; consider doctests for CLI examples.
  - [Source](../architecture/testing-strategy.md)
  - [Source](../architecture/documentation-strategy.md)

### Technical Constraints

- Runtime: Deno 2; Language: TypeScript; centralized deps via `deps.ts`.
  - [Source](../architecture/tech-stack.md)

### Assumptions

- `deno.json` or `deno.jsonc` exists at the repository root and defines tasks under the standard `tasks` map; Toolkit Service will read this file by default. No specific path guidance found in architecture docs.
  - [Source](../architecture/components.md#core-services)
- CLI bypass will use `Deno.Command` to execute tasks and propagate exit codes; requires appropriate permissions.
  - [Source](../architecture/tech-stack.md)

### Permissions

- CLI bypass will require appropriate permissions to run subprocesses and read `deno.json`/`deno.jsonc`.
  - [Source](../architecture/components.md#core-services)

### Edge Cases & Error Behavior

- Missing `deno.json`/`deno.jsonc` or unreadable file:
  - Service: treat as no tasks discovered; return empty array
  - View: render "No tasks found"
  - CLI: print "No tasks found" and exit with code `1`
- Empty `tasks` map:
  - View: render "No tasks found"
  - CLI: print "No tasks found" and exit with code `1`
- Unknown task name:
  - Service: reject with clear error listing available tasks
  - CLI: print suggestions (available tasks) and exit with code `1`
- Subprocess/permission errors (`Deno.errors.PermissionDenied`, spawn failures):
  - CLI: print error message and exit with code `1`

### Project Structure Notes

- Keep new files aligned with the unified structure; ensure imports are centralized and version-pinned.
  - [Source](../architecture/unified-project-structure.md#tui-application-structure)

## Change Log

| Date       | Version | Description                                   | Author |
| ---------- | ------- | --------------------------------------------- | ------ |
| 2025-08-15 | v0      | Initial Draft created for Story 2.2           | SM     |
| 2025-08-15 | v1      | Updated per PO validation report: refined ACs, tasks (DI createServices, mount view, CLI usage), edge cases/error behavior, permissions, CLI details | SM     |
| 2025-08-15 | v2      | Implemented Toolkit Service, Toolkit Menu View, and CLI bypass; wired DI and routing; added tests for service, view, and CLI; lint/test pass | Dev    |
| 2025-08-16 | v3      | Added missing tests for Back action (AC2) and centralized deps policy (AC4); fixed lint warnings; updated status to Ready for Done | Dev    |

## Dev Agent Record

### Agent Model Used

- Cascade

### Debug Log References

- `deno lint` — 0 problems
- `deno test -A` — 18 passed, 0 failed
- Key tests:
  - `tests/services/toolkit_service_test.ts`
  - `tests/tui/toolkit_menu_view_test.ts`
  - `tests/cli/toolkit_cli_test.ts`
  - `tests/tui/toolkit_menu_view_back_test.ts`
  - `tests/policy/deps_policy_test.ts`

### Completion Notes List

- Implemented `ToolkitServiceImpl` with JSON/JSONC discovery and subprocess execution via `Deno.Command` or injected exec
- Added `ToolkitMenuView` to list tasks, run selection, show result, and navigate back
- Wired DI in `src/core/di.ts` and ensured TUI CLI uses `createServices()`
- Extended `src/main.ts` with `mainAsync()` and `--toolkit` bypass including pass-through args handling
- Added comprehensive tests for service, view, and CLI; ensured lint clean

### File List

- Updated: `src/services/toolkit_service.ts`
- Updated: `src/core/di.ts`
- Updated: `src/tui/views/ToolkitMenuView.ts`
- Updated: `src/tui/TuiApplication.ts`
- Updated: `src/tui/cli.ts`
- Updated: `src/main.ts`
- Updated: `src/core/state/installation_state.ts`
- Added: `tests/services/toolkit_service_test.ts`
- Added: `tests/tui/toolkit_menu_view_test.ts`
- Added: `tests/cli/toolkit_cli_test.ts`
- Added: `tests/tui/toolkit_menu_view_back_test.ts`
- Added: `tests/policy/deps_policy_test.ts`

## QA Results

### Review Date: 2025-08-15

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Implementation aligns with ACs. Clean DI boundaries; CLI bypass handles unknown tasks and exit codes; centralized deps via `deps.ts`.
- Tests cover service discovery/execution, view behavior (empty state/selection), and CLI bypass; lint clean.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓
- All ACs Met: ✓

### Security Review

- Subprocess execution via `Deno.Command` with `--allow-read` and `--allow-run`; unknown tasks print suggestions; no high-severity findings.

### Performance Considerations

- No performance risks at current scope.

### Files Modified During Review

- None

### Gate Status

Gate: PASS → qa.qaLocation/gates/2.2-toolkit-service-toolkit-view-and-cli-bypass.yml

### Recommended Status

✓ Ready for Done

### Supporting Evidence

- Unit tests: 16 passed, 0 failed (Deno 2)
- Lint: 0 problems
- DoD self-check: All ACs met; docs doctests passed; CLI usage documented; story cross-links updated; status set to Ready for Review.
