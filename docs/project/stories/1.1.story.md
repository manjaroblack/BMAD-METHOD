# Story 1.1: Deno configuration verification and alignment

## Status

Done

## Story

**As a** Developer,
**I want** deno.jsonc verified and aligned with our TypeScript/Deno rules,
**so that** formatting, linting, testing, dependency strategy, and tasks are standardized and reproducible.

## Acceptance Criteria

1. deno.jsonc enforces strict TypeScript settings per rules (strict, noImplicitAny, explicit returns), and the checkJs policy is decided and documented.
2. deps.ts exists and centralizes both external (JSR-first) and internal imports; no direct deep imports in app code.
3. deno task commands exist and run: fmt, fmt:check, lint, lint:fix, test, bench, coverage, cache, upgrade, lock:freeze.
4. fmt and lint include/exclude patterns match our repo layout and do not scan dist/vendor/node_modules/.git.
5. Node compatibility stance set (no node_modules); import strategy is Web APIs/JSR-first.
6. Tests discover correctly (globs) and pass on a clean run; coverage task produces coverage.lcov.
7. Lockfile path defined and can be frozen in CI (deno lock --frozen).
8. Unstable features list is justified or trimmed; any enabled flags are documented in Dev Notes.
9. Workspace (if used) globs are valid or removed if not needed.
10. CI note: configuration is ready for GitHub Actions (or documented as a follow-up if not in scope).

## Tasks / Subtasks

- [x] Review deno.jsonc against rules doc and architecture (AC 1,5)
  - [x] Verify compilerOptions align with strictness and JSX strategy (AC 1)
  - [x] Decide and document checkJs policy (TS-only vs mixed) (AC 1)
  - [x] Validate fmt include/exclude and settings (AC 4)
  - [x] Validate lint rules/tags include/exclude; tighten/trim as needed (AC 4)
  - [x] Verify test/bench globs and exclusions (AC 6)
  - [x] Verify lock path and frozen workflow (AC 7)
  - [x] Review unstable flags list; keep only required with rationale (AC 8)
  - [x] Validate workspace entries or remove if unneeded (AC 9)
  - [x] Confirm nodeModulesDir none and npmRegistry stance (AC 5)
- [x] Ensure deps.ts centralizes imports (AC 2)
  - [x] Add JSR imports (@std, third-party) and internal exports per pattern (AC 2)
  - [x] Update sample app imports to use "deps" alias (AC 2,5)
- [x] Validate tasks block (AC 3)
  - [x] Ensure each task runs locally: fmt, lint, test, coverage, bench, cache, upgrade, lock:freeze (AC 3,6,7)
- [x] Document decisions in Dev Notes and add CI note (AC 10)

## Dev Notes

### Previous Story Insights

- No previous story exists. This is the first story in Epic 1.

### Data Models

- Not applicable for this configuration story. No data models are introduced.

### API Specifications

- Not applicable. No API endpoints are introduced in this story.

### Component Specifications

- Not applicable. No UI components are introduced in this story.

### File Locations

- Root configuration: `deno.jsonc` at project root. [Source](../architecture/unified-project-structure.md#tui-application-structure)
- Centralized dependencies: `deps.ts` at project root. [Source](../typescript-rules.md#dependency--import-strategy-jsr-first-depsts-pinning)
- Tests should reside in top-level `tests/` mirroring `src/`. [Source](../architecture/testing-strategy.md)

### Testing Requirements

- Use Deno's built-in test runner. [Source](../architecture/testing-strategy.md)
- Test discovery via globs for `**/*_test.ts(x)` and `**/*.test.ts(x)`. [Source](../architecture/testing-strategy.md)
- Coverage should be generated and exported to lcov (`coverage.lcov`). [Source](../architecture/testing-strategy.md)

### Technical Constraints

- Runtime: Deno (latest stable). Language: TypeScript. [Source](../architecture/tech-stack.md#tech-stack)
- Strict TypeScript configuration (strict types, explicit returns). [Source](../typescript-rules.md#core-rules--rationale)
- Centralize dependencies in `deps.ts`; JSR-first for externals; re-export internal modules. [Source](../typescript-rules.md#dependency--import-strategy-jsr-first-depsts-pinning)
- Explicit `.ts` extensions for internal imports. [Source](../typescript-rules.md#core-rules--rationale)
- Prefer Web APIs/JSR over Node polyfills; `nodeModulesDir` should be `none`. [Source](../typescript-rules.md#node-compatibility-stance-web-apis-first)
- Organize project per unified structure; keep `legacy/` archived. [Source](../architecture/unified-project-structure.md#tui-application-structure)
- Logging/testing patterns per docs; prioritize Deno-native patterns. [Source](../typescript-rules.md#deno-native-patterns)

### Testing

- Test file location: top-level `tests/` mirroring `src/`. [Source](../architecture/testing-strategy.md)
- Testing frameworks/patterns: Deno test runner; include property-based tests where applicable. [Source](../typescript-rules.md#testing-the-deno-way)
- Coverage generation: `deno coverage coverage --lcov > coverage.lcov`. [Source](../architecture/testing-strategy.md)
- Any E2E (future): run TUI as subprocess and assert on text output. [Source](../architecture/testing-strategy.md)

### Project Structure Notes

- Ensure `fmt`/`lint` include/exclude patterns match `src/`, `tests/`, and avoid `dist/`, `vendor/`, `node_modules/`, `.git/`. [Source](../typescript-rules.md#project-configuration--ci)
- Validate `workspace` entries only if monorepo structure (`packages/`, `apps/`, `tools/`) is present; otherwise remove to reduce noise. [Source](../typescript-rules.md#project-configuration--ci)

### Debug Log References

- See `.ai/debug-log.md` for any traces captured during development.

### Completion Notes List

- checkJs policy: set to `false` (TS-first). Rationale: enforce TypeScript-only sources per rules, simplify tooling, avoid mixed JS/TS pitfalls.
- Strict TS: enabled `strict`, `noImplicitAny`, `noImplicitReturns`, `noUncheckedIndexedAccess`, `noImplicitOverride`, etc., aligning with rules.
- Lint: simplified to `rules.tags = ["recommended"]` to reduce noise; rely on Deno recommended set.
- Format/Lint scopes: include `src/`, `tests/`, `benches/`, `scripts/`; exclude `dist/`, `coverage/`, `vendor/`, `node_modules/`, `.git/`, minified assets.
- Test/Bench discovery: switched to glob-based discovery only; removed non-existent dir entries; added smoke test and minimal bench to validate tasks.
- Workspace: removed unused monorepo globs to reduce config noise.
- Unstable flags: removed; none required at this time. Will justify individually if added in future.
- Node stance: `nodeModulesDir = none`; Web APIs/JSR-first; `imports` maps `deps` to centralized `deps.ts`.
- Lockfile: path set to `deno.lock`; added `lock:write` and `lock:freeze` tasks. CI should run `deno task lock:freeze`.
- Bench task: removed unsupported `--fail-fast` flag for current Deno.
- CI Note: Config is CI-ready. In CI, run `deno task cache` then `deno task lock:freeze`, and use `deno task fmt:check`, `deno task lint`, `deno task test`, and optionally `deno task bench`.

### File List

- `deno.jsonc`
- `deps.ts`
- `tests/`
- `src/`
- `benches/`
- `scripts/`
- `.github/workflows/ci.yml`
- `coverage.lcov`
- `deno.lock`

## QA Results

### Initial Findings (superseded)

These were the initial review notes at 21:38; they are retained for history and have been addressed per final approval below:

- CI coverage artifact path needed adjustment
- fmt/lint included a nonexistent `scripts/` directory
- Tasks validated AC 3/6/7 locally

### Review Date: 2025-08-11 21:52 -05:00

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

All previously noted issues have been resolved per product decision:

- Lint rules retained as-is.
- Trimmed fmt/lint includes to remove the nonexistent `scripts/` directory.
- CI now uploads only `coverage.lcov`; corrected the `if: always()` syntax.
- Local `fmt:check`, `lint`, `test`, and `bench` all pass.

### Refactoring Performed

- **File**: .github/workflows/ci.yml
  - **Change**: Removed `coverage/html` from artifact upload and set `if: always()`
  - **Why**: Align CI artifacts with what we generate; avoid missing artifact failures
  - **How**: Uploads only the lcov file; keeps workflow simple and robust

- **File**: deno.jsonc
  - **Change**: Removed `scripts/` from `fmt.include` and `lint.include`
  - **Why**: Directory does not exist; avoids unnecessary scanning/noise
  - **How**: Cleaned include lists while keeping all rules intact

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓
- All ACs Met: ✓

### Improvements Checklist

- [x] Align CI artifacts to upload only coverage.lcov
- [x] Trim fmt/lint includes (remove scripts/)
- [ ] Optional: add a `coverage:html` task for local HTML artifact generation
- [ ] Optional: extend `deps.ts` with internal re-exports as modules are added

### Security Review

- No issues observed. Continue pinning remote tooling URLs and reviewing updates.

### Performance Considerations

- No performance concerns with the configuration; CI cache keyed by `deno.lock` is appropriate.

### Final Status

Approved - Ready for Done

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-08-11 | 0.1 | Initial draft created for Story 1.1 (Deno config verification) | Scrum Master |
| 2025-08-12 | 0.2 | Completed tasks and added Dev Notes, CI note, Completion Notes, and File List | Dev Agent |

## Dev Agent Record

### Agent Model Used

- {{agent_model_name_version}}
