# Story 2.3: Config Service and Open Core Config Command

## Status

Done

## Story

**As a** Developer, **I want** a command to open the core configuration file (`bmad-core/core-config.yaml`), **so that** I can quickly review or edit project settings without searching the repository.

### Dependencies

- Depends on completion of Story 2.2
- Parent Epic: [Epic 2 – TUI Core & Toolkit Implementation](../prd/epic-2-tui-core-toolkit-implementation.md)

## Acceptance Criteria

1. Config Service
   - Provide a `Config Service` that handles interactions with configuration files (focus: `core-config.yaml`).
   - Expose at minimum:
     - `getCoreConfigPath(): string` — returns the absolute path to `bmad-core/core-config.yaml`.
     - `openCoreConfig(): Promise<{ code: number }>` — opens the file using the system default application and resolves with the exit code (0 on success).
   - Implemented via dependency injection and consumable by CLI and (optionally) views.
   - [Source](../architecture/components.md#core-services)
   - [Source](../architecture/backend-architecture-core-services.md)
2. CLI command (bypass; does not launch TUI)
   - Add a CLI option `--open-config` that invokes `ConfigService.openCoreConfig()` and prints a result message.
   - On success: print `Opened core-config.yaml` and exit with `0`.
   - On failure (e.g., file not found, permission denied, opener failed): print an actionable error and exit with `1`.
   - Required permissions: `--allow-read`, `--allow-run`.
   - [Source](../prd/epic-2-tui-core-toolkit-implementation.md)
   - [Source](../architecture/tech-stack.md)
3. Centralized dependencies
   - All external imports go through `deps.ts` (JSR-first; pinned URLs where needed).
   - [Source](../typescript-rules.md#dependency--import-strategy-jsr-first-depsts-pinning)
   - [Source](../architecture/coding-standards.md)
4. Tests
   - Service unit tests:
     - `getCoreConfigPath()` returns expected path.
     - `openCoreConfig()` success path using an injected opener stub.
     - Error paths: missing file, opener failure, permission errors handled.
   - CLI tests:
     - `--open-config` invokes service and prints success; exit code `0`.
     - Failure path prints actionable message; exit code `1`.
   - Tests reside under top-level `tests/` mirroring `src/`.
   - [Source](../architecture/testing-strategy.md)

## Tasks / Subtasks

- [x] Config Service (AC: 1,3)
  - [x] Define `ConfigService` interface in `src/services/config_service.ts` with `getCoreConfigPath()` and `openCoreConfig()`.
  - [x] Implement `ConfigServiceImpl` resolving `bmad-core/core-config.yaml` from repo root and opening via injected opener.
  - [x] Add JSDoc for public APIs (examples, permissions).
- [x] DI & Wiring (AC: 1,2,3)
  - [x] Provide concrete `ConfigService` in `src/core/di.ts` (`createServices()` for production; retain stubs for tests).
  - [x] Ensure CLI entry uses DI-provided `ConfigService`.
- [x] CLI Bypass (AC: 2,3)
  - [x] Extend `src/main.ts` to parse `--open-config` (use `parseFlags` from `deps.ts`).
  - [x] Do not launch the TUI when `--open-config` is provided; just execute and exit with service result code.
  - [x] Print clear success/error messages.
- [x] Tests (AC: 4)
  - [x] `tests/services/config_service_test.ts`: path resolution; opener success/failure; missing file handling.
  - [x] `tests/cli/config_cli_test.ts`: `--open-config` happy and error paths; exit codes.
- [x] Documentation links (Epic alignment)
  - [x] Cross-link this story to [Epic 2](../prd/epic-2-tui-core-toolkit-implementation.md) and reference core services/components.

### Task–AC Mapping

| Task | ACs |
| :--- | :--- |
| Config Service | 1, 3 |
| DI & Wiring | 1, 2, 3 |
| CLI Bypass | 2, 3 |
| Tests | 4 |
| Documentation links | - |

## Dev Notes

### Previous Story Insights

- Reuse DI patterns and CLI bypass strategy established in Story 2.2 for toolkit; follow the same permissions model and message formatting.
  - [Source](./2.2.story.md#dev-notes)

### Services

- Config Service is part of Core Services and should follow the in-process modular service pattern with DI.
  - [Source](../architecture/components.md#core-services)
  - [Source](../architecture/backend-architecture-core-services.md)

### File Locations

- Service under `src/services/`; DI under `src/core/`; CLI entry in `src/main.ts`; tests under `tests/` mirroring `src/`.
  - [Source](../architecture/unified-project-structure.md#tui-application-structure)

### Testing Requirements

- Use Deno test runner. Prefer per-test permissions in `Deno.test` where applicable. Stub subprocess/opener for unit tests.
  - [Source](../architecture/testing-strategy.md)

### Technical Constraints

- Runtime: Deno 2; Language: TypeScript; centralized deps via `deps.ts`.
  - [Source](../architecture/tech-stack.md)
  - [Source](../architecture/coding-standards.md)

### Edge Cases & Error Behavior

- File missing (`bmad-core/core-config.yaml` not found):
  - CLI prints `core-config.yaml not found at <path>`; exit code `1`.
- Permission denied (read/run):
  - Print error and guidance to include `--allow-read --allow-run`; exit code `1`.
- Opener failure (non-zero exit):
  - Print `Failed to open core-config.yaml (code <n>)`; exit code `1`.

### Project Structure Notes

- Keep new files aligned with the unified structure; ensure imports are centralized and version-pinned.
  - [Source](../architecture/unified-project-structure.md#tui-application-structure)

## Change Log

| Date       | Version | Description                                                         | Author |
| ---------- | ------- | ------------------------------------------------------------------- | ------ |
| 2025-08-16 | v0      | Initial Draft created for Story 2.3                                 | SM     |
| 2025-08-17 | v1      | Implemented service, DI wiring, CLI flag, tests; lint/test pass     | Dev    |

## Dev Agent Record

### Agent Model Used

- Cascade

### Debug Log References

- `deno lint` — 0 problems
- `deno test` — 26 passed, 0 failed
- Key tests:
  - `tests/services/config_service_test.ts`
  - `tests/cli/config_cli_test.ts`
  - `tests/policy/deps_policy_test.ts`

### Completion Notes List

- Implemented `ConfigService` interface and `ConfigServiceImpl` to resolve and open `bmad-core/core-config.yaml` with platform-specific opener via DI.
- Wired `ConfigService` into DI (`src/core/di.ts`) with real and stub implementations.
- Extended CLI (`src/main.ts`) with `--open-config` using DI-provided service; prints success/error and exits accordingly.
- Added unit tests for service and CLI; updated TUI tests to include a minimal `config` stub to satisfy DI.
- Ensured centralized imports via `deps.ts`; lint clean.

### File List

- Added: `tests/services/config_service_test.ts`
- Added: `tests/cli/config_cli_test.ts`
- Updated: `src/services/config_service.ts`
- Updated: `src/core/di.ts`
- Updated: `src/main.ts`
- Updated: `tests/tui/toolkit_menu_view_test.ts`
- Updated: `tests/tui/toolkit_menu_view_back_test.ts`

## QA Results

### Review Date: 2025-08-17

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

- Implementation aligns with ACs: service and CLI behave as specified; DI wiring correct; centralized deps via `deps.ts`.
- Tests cover service success/failure and CLI success/error paths; suite passes (26/26).

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓
- All ACs Met: ✓

### Security Review

- Uses `Deno.Command` to open files; messages guide inclusion of `--allow-read` and `--allow-run`. No high-severity concerns.

### Performance Considerations

- None at this scope.

### Files Modified During Review

- None

### Gate Status

Gate: PASS → qa.qaLocation/gates/2.3-config-service-and-open-core-config-command.yml

### Recommended Status

✓ Ready for Done
