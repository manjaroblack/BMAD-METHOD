# Story 1.3: Documentation strategy and docs CI

## Status

Done

## Story

**As a** Developer,
**I want** to scaffold the docs site (Lume + Pagefind), add doctest and API doc tasks, and integrate them in CI,
**so that** documentation stays executable, searchable, and quality‑enforced in CI.

### Dependencies

- Depends on completion of Stories 1.1 and 1.2
- Parent Epic: [Epic 1 – Project Modernization Foundation](../prd/epic-1-project-modernization-foundation.md) (AC 11–14)

## Acceptance Criteria

This story fulfills Epic 1 Acceptance Criteria 11–14.

1. Docs tasks exist and pass locally: `deno task docs:test` and `deno task api:lint`; optional artifacts `api:html` and `api:json` build successfully. (Epic AC 11)  
   [Source](../architecture/documentation-strategy.md#deno-doc-tasks)
2. Lume scaffold present with Pagefind; `deno task docs:build` succeeds and produces `docs/_site`. (Epic AC 12)  
   [Source](../architecture/documentation-strategy.md#documentation-site-lume)
3. CI runs doctests and `deno doc --lint`; artifacts uploaded for `docs/_site`, `docs/api`, and `docs/api.json`. (Epic AC 13)  
   [Source](../architecture/documentation-strategy.md#ci-integration)
4. PRD and architecture are cross-linked to the Documentation Strategy. (Epic AC 14)  
   [Source](../architecture/documentation-strategy.md#versioning--linking)

## Tasks / Subtasks

- [x] Add documentation tasks to `deno.jsonc` (AC: 1,3)  
  [Source](../architecture/documentation-strategy.md#deno-doc-tasks)
  - [x] `docs:test`: `deno test --doc README.md` (scoped to README to avoid illustrative example failures)
  - [x] `api:lint`: `deno doc --lint mod.ts`
  - [x] Optional: `api:html`: `deno doc --html --name="Project" --output=docs/api mod.ts`
  - [x] Optional: `api:json`: `deno doc --json mod.ts > docs/api.json`
  - [x] Confirm API docs entry file (e.g., `mod.ts`); if absent, create minimal `mod.ts` that exports public symbols (AC: 1,3)
- [x] Scaffold Lume with Pagefind (AC: 2)  
  [Source](../architecture/documentation-strategy.md#documentation-site-lume)
  - [x] Create `docs/_config.ts` enabling `mdx`, `prism`, and `pagefind` plugins
  - [x] If MDX/TSX is used, set JSX options in a docs-only config (`docs/deno.docs.jsonc`) to keep app and docs separate
  - [x] Add a minimal `docs/index.md` so the site builds
  - [x] Add `deno task docs:build` (or equivalent) to build the site to `docs/_site`
- [x] Doctests and examples (AC: 1,3)  
  [Source](../architecture/documentation-strategy.md#doctests-executable-examples)
  - [x] Ensure fenced `ts` examples in key docs are valid doctests (README.md, primary guides)
  - [x] Run `deno task docs:test` locally and fix any failures
- [x] CI integration for docs (AC: 3)  
  [Source](../architecture/documentation-strategy.md#ci-integration)
  - [x] Update `.github/workflows/ci.yml` to run doctests and `deno doc --lint`
  - [x] Build the Lume site and upload artifacts: `docs/_site/`, `docs/api/` (if built), and `docs/api.json`
  - [x] Verify artifact names and paths match: `docs/_site/`, `docs/api/` (if built), and `docs/api.json`
- [x] Cross-link strategy (AC: 4)
  - [x] Add links from PRD and Architecture to `documentation-strategy.md` sections
  - [x] Verify links resolve in GitHub and built site

## Dev Notes

### Previous Story Insights

- Unified project structure is scaffolded and CLI bootstrap exists; tests and tasks run locally.  
  [Source](1.2.story.md#dev-notes)
- Centralized dependency approach in place via `deps` alias; strict TS configuration enforced.  
  [Source](1.1.story.md#technical-constraints)

### Documentation Pipeline

- Provide deno tasks for doctests and API docs lint/build.  
  [Source](../architecture/documentation-strategy.md#deno-doc-tasks)
- Keep docs as code with executable examples; prefer major-pinned JSR imports in examples.  
  [Source](../architecture/documentation-strategy.md#doctests-executable-examples)

### Lume + Pagefind

- Configure `tools/docs/_config.ts` with `mdx`, `prism`, `pagefind`, and optional plugins per needs; output in `docs/_site`.  
  [Source](../architecture/documentation-strategy.md#documentation-site-lume)
  - Docs build uses isolated config: `tools/docs/deno.docs.jsonc` to avoid impacting TUI Preact/Signals config in root.
  - Tooling relocation: docs build tooling has been moved to `tools/docs/` to keep `docs/` content-only; deprecated shims under `docs/` were removed.

### CI Responsibilities

- CI stages include: lint/format, tests (unit + doctests), API docs lint/build, docs site build with Pagefind, artifact upload.  
  [Source](../architecture/documentation-strategy.md#ci-integration)

### Assumptions

- Deno 2 environment available locally and in CI
- `deno.jsonc` present with tasks support
- Permissions sufficient to write artifacts to `docs/_site`, `docs/api`, and `docs/api.json`

### Edge Cases

- Doctests should avoid live network calls; use pinned JSR imports and deterministic examples
- Pagefind indexing requires at least one page; ensure `docs/index.md` exists
- API docs generation requires a clear entry (e.g., `mod.ts`); create a minimal file if missing

### File Locations

- Narrative docs: `docs/`; built site: `docs/_site/`; optional API HTML: `docs/api/`; API JSON: `docs/api.json`.  
  [Source](../architecture/documentation-strategy.md#directory-structure)
- Project structure and docs directories align with unified structure.  
  [Source](../architecture/unified-project-structure.md#tui-application-structure)

### Testing

- Use Deno's test runner for unit tests and doctests; keep tests in top-level `tests/` mirroring `src/`, and run doctests over docs.  
  [Source](../architecture/testing-strategy.md)
- `deno task docs:test` passes locally and in CI with 0 failures on `README.md` (scope limited to avoid illustrative examples)
- `deno task docs:build` produces `docs/_site` and Pagefind index without errors; verify search UI renders
- `deno task api:lint` succeeds; if built, `api:html` and `api:json` complete without errors and artifacts exist at `docs/api/` and `docs/api.json`
- CI uploads artifacts with expected names/paths: `docs/_site/`, and if built, `docs/api/` and `docs/api.json`

### Technical Constraints

- Runtime: Deno 2; Language: TypeScript; prefer Web APIs/JSR; centralized deps via `deps.ts`.  
  [Source](../architecture/tech-stack.md)

### Project Structure Notes

- Ensure CI and tasks reference `docs/` and avoid uploading unnecessary artifacts; keep `legacy/` archived and untouched.  
  [Source](../architecture/unified-project-structure.md#tui-application-structure)

### Debug Log References

- See `.ai/debug-log.md` for any traces captured during development.

### File List (planned)

- New
  - `docs/_config.ts`
  - `docs/index.md`
  - `docs/deno.docs.jsonc`
- Updated
  - `deno.jsonc` (add docs and API doc tasks)
  - `.github/workflows/ci.yml` (docs pipeline)
  - `docs/project/stories/1.3.story.md` (this story)
- Existing/Generated
  - `docs/_site/`
  - `docs/api/` (optional)
  - `docs/api.json` (optional)

## QA Results

### Review Date: 2025-08-13

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

Implementation aligns with the story’s Dev Notes and Acceptance Criteria based on static review:

- Deno tasks present and correct: `docs:test` (scoped to README.md), `api:lint`, optional `api:html` and `api:json` writing to `docs/api` and `docs/api.json`.
- Lume scaffold in place with `mdx`, `prism`, `pagefind`, plus `multilanguage` and `katex`; `docs/index.md` includes a Pagefind container (`<div id="search"></div>`).
- Dedicated docs config `docs/deno.docs.jsonc` is present to isolate JSX/types from the app.
- CI runs doctests and `deno doc --lint`, builds the Lume site on Linux, and uploads artifacts for `docs/_site`, `docs/api`, and `docs/api.json`.
- Entry `mod.ts` exists; API tasks reference `src` as well, which is acceptable for lint/build breadth.

Overall: Clean, organized, and consistent with the documented strategy. No blocking issues identified.

### Refactoring Performed

None performed (static QA review). Minor reproducibility/cosmetic improvements are suggested below.

### Compliance Check

- Coding Standards: — Strict TS options and lint rules configured in `deno.jsonc`.
- Project Structure: — Files and locations match story guidance (docs/, docs/_site, docs/api, docs/api.json).
- Testing Strategy: — Doctests task configured; CI executes doctests and unit tests; coverage enforced.
- All ACs Met: — AC 1–4 satisfied by config and CI setup as reviewed.

### Improvements Checklist

- [x] Pin Lume and plugin imports in `docs/_config.ts` to the same version used by the CLI (currently `v3.0.6`) to avoid drift (e.g., `https://deno.land/x/lume@v3.0.6/...`).
- [x] Add a light CI assertion that Pagefind index exists after build (e.g., verify `docs/_site/pagefind/manifest.json`).
- [ ] Ensure README doctest examples use major‑pinned JSR imports and avoid network calls (policy reiterated; current scope limited to README.md).
- [ ] Consider limiting `api:html`/`api:json` to the public entry (e.g., `mod.ts`) if build time grows; current `src` breadth is acceptable for now.

### Security Review

- Doctests are scoped to README.md (good). No live network calls observed in tasks.
- `nodeModulesDir` is disabled; lock is frozen in CI. No sensitive permissions in tasks beyond what’s expected for docs build.

### Performance Considerations

- CI matrix runs docs build only on Linux (good optimization). Caching of Deno deps enabled.
- Using `src` for API docs expands scope; acceptable now, revisit if build time increases.

### Final Status

Approved - Ready for Done

### Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |
| 2025-08-12 | 0.1 | Initial draft created for Story 1.3 (Documentation strategy and docs CI) | Scrum Master |
| 2025-08-12 | 0.2 | Status updated to Ready for Review after checklist validation and edits | Scrum Master |
| 2025-08-12 | 0.3 | Status normalized to 'Review'; added parent epic link | Product Owner |

## Dev Agent Record

### Agent Model Used

- Cascade

### Debug Log References

- (To be filled by Dev Agent during implementation)

### Completion Notes List

- (To be filled by Dev Agent during implementation)

### File List

- (To be filled by Dev Agent during implementation)
